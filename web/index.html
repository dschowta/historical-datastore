<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="icon" href="../../favicon.ico">

	<title>Historical Datastore</title>

	<!-- JS -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.17.0/URI.min.js"></script>
	<script src="lib/tablefilter/tablefilter.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.9/css/bootstrap-dialog.min.css" rel="stylesheet" type="text/css" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.9/js/bootstrap-dialog.min.js"></script>
	<script type="text/javascript" src="http://momentjs.com/downloads/moment.js"></script>
	<script src="lib/datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
	<script src="lib/jszip/jszip.min.js"></script>
	<script src="lib/filesaver/FileSaver.min.js"></script>


	<!-- CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
	<link rel="stylesheet" href="lib/datetimepicker/css/bootstrap-datetimepicker.min.css" />
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="style.css">

</head>

<body>


	<nav class="navbar navbar-inverse navbar-fixed-top">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="#">Historical-Datastore</a>
			</div>
			<div id="navbar" class="collapse navbar-collapse">
				<ul class="nav navbar-nav">
					<li class="active"><a href="#">Registry</a></li>
					<li class="disabled"><a href="#">Data</a></li>
					<li class="disabled"><a href="#">Aggregation</a></li>
				</ul>
				<ul class="nav navbar-nav navbar-right">
					<li><a href="#" id="login" class="navbar-link" onclick="localStorage.removeItem('ticket');"><!--Set dynamically--></a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container-fluid">

		<h1>Registry<i class="fa fa-cog fa-spin spinner-h1 hidden"></i></h1>

		<!--<button class="btn btn-default" data-toggle="modal" data-target="#registryExport" disabled="disabled">Export registry</button>-->
		<button class="btn btn-default" data-toggle="modal" data-target="#dataExport" onclick="getTotalFiltered();">Export data</button>
		<!--<button class="btn btn-default" data-toggle="modal" data-target="#aggrExport" disabled="disabled">Export aggregations</button>-->
		<table id="entries" class="center-block">
			<thead>
				<tr>
					<!-- Added dynamically -->
				</tr>
			</thead>
			<tbody>
				<!-- Added dynamically -->
			</tbody>
		</table>

		<!-- Modal -->
		<div class="modal fade" id="dataExport" role="dialog">
			<div class="modal-dialog">

				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Export data <em class="modalStat"></em></h4>
					</div>
					<div class="modal-body">
						<label>Interval:</label>
						<div class="row">
							<div class='col-md-6'>
								<div class="form-group">
									<div class='input-group date' id='datetimepickerStart'>
										<input type='text' class="form-control" />
										<span class="input-group-addon">
											<span class="glyphicon glyphicon-calendar"></span>
										</span>
									</div>
								</div>
							</div>
							<div class='col-md-6'>
								<div class="form-group">
									<div class='input-group date' id='datetimepickerEnd'>
										<input type='text' class="form-control" />
										<span class="input-group-addon">
											<span class="glyphicon glyphicon-calendar"></span>
										</span>
									</div>
								</div>
							</div>
						</div>

						<script type="text/javascript">
							$(function () {
								$('#datetimepickerStart').datetimepicker({
									format: "YYYY-MM-DDTHH:mm:ss"
								});
								$('#datetimepickerEnd').datetimepicker({
									useCurrent: false, //Important! See issue #1075
									format: "YYYY-MM-DDTHH:mm:ss"
								});
								$("#datetimepickerStart").on("dp.change", function (e) {
									$('#datetimepickerEnd').data("DateTimePicker").minDate(e.date);
								});
								$("#datetimepickerEnd").on("dp.change", function (e) {
									$('#datetimepickerStart').data("DateTimePicker").maxDate(e.date);
								});
							});
						</script>

						<label>Attributes:</label><em><div id="sampleAttributes"><!--Set dynamically--></div></em>
						<div class="row">
							<div class='col-md-6'>
								<input id="attributes" class="form-control" type="text" value="time,name,value,unit" />
							</div>
						</div>

						<br />
						<label>Output:</label>
						<div class="row">
							<div class="col-md-6 checkbox">

								<div class="dropdown">
									<button class="btn btn-default dropdown-toggle" type="button" id="exportFormat" data-toggle="dropdown">CSV<span class="caret"></span></button>
									<ul class="dropdown-menu" role="menu" aria-labelledby="menu1">
										<li class="dropdown-header">Format</li>
										<li role="presentation"><a role="menuitem" tabindex="-1" href="#">CSV</a></li>
									</ul>
								</div>
							</div>	
						</div>
						<div class="row">
							<div class="col-md-6 checkbox">

								<div class="dropdown">
									<button class="btn btn-default dropdown-toggle" type="button" id="exportType" data-toggle="dropdown">One file per source (zipped)<span class="caret"></span></button>
									<ul class="dropdown-menu" role="menu" aria-labelledby="menu1">
										<li class="dropdown-header">Mode</li>
										<li role="presentation"><a role="menuitem" tabindex="-1" href="#">One file per source (zipped)</a></li>
										<li role="presentation"><a role="menuitem" tabindex="-1" href="#">All sources in a single file</a></li>
									</ul>
								</div>
							</div>	
						</div>	

					</div>

					<script type="text/javascript">
						$(function () {
							$(".dropdown-menu li a").click(function(){
								$(this).parents('.dropdown').find('.dropdown-toggle').html($(this).text()+'<span class="caret"></span>');
							});
						});
					</script>

					<div class="modal-footer">
						<button type="button" class="btn btn-primary" onclick="exportData();">Export<i class="fa fa-cog fa-spin spinner-button hidden"></i></button>
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div>

			</div>
		</div>



	</div><!-- /.container -->

	<div class="footer">
		Â© 2016 LinkSmart <a href="https://linksmart.eu/redmine/projects/historical-datastore">Historical-Datastore</a> | Hosted by <a href="http://www.fit.fraunhofer.de">Fraunhofer FIT</a> | <a href="http://www.fit.fraunhofer.de/en/imprint.html">Imprint</a> | <a href="http://www.fit.fraunhofer.de/en/data_protection.html">Data Protection Policy</a>
	</div>

	<script>
		// Global variables
		var dataAttributes = {
			"name": "n",
			"time": "t",
			"value": "v",
			"unit": "u"
		}
		var omitAttrs = ["url", "data", "retention", "aggregation"];
		var configFile = "conf/autogen_config.json";
		
		// DO NOT CHANGE
		var hdsURL;
		var loginURL;
		var logoutURL;
		var entriesTable;

		$.ajax({
			dataType: "json",
			url: configFile,
			success: function(json) {
				hdsURL = json.hdsEndpoint;
				
				if(json.authEnabled){
					switch(json.authProvider) {
						case 'cas':
						loginURL = json.authProviderURL + "/login?service=" + json.authServiceID;
						logoutURL =  json.authProviderURL + "/logout";
						break;
						default:
						bootstrapDialog({
							type: BootstrapDialog.TYPE_DANGER,
							closable: false,
							title: 'Unsupported authenticator',
							message: 'Authentication provider is not supported: ' + json.provider
						});
					}
					$("#login").text("Login");
					$("#login").attr("href", loginURL);
				}
				
				main();
			},
			error: function(e) {
				console.error(e);
				bootstrapDialog({
					type: BootstrapDialog.TYPE_DANGER,
					closable: false,
					title: 'Configuration Error: ' + e.status + ' ' + e.statusText,
					message: 'Unable to load configuration file: ' + configFile
				});
			}
		});



		function error_401(){
			$("#login").text("Login");
			$("#login").attr("href", loginURL);
			localStorage.removeItem('ticket');
			
			bootstrapDialog({
				type: BootstrapDialog.TYPE_WARNING,
				closable: true,
				title: '401 Unauthorized',
				message: 'No active session. Please login.',
				buttons: [{
					label: 'Login',
					action: function(dialog) {
						dialog.close();
						window.location = loginURL;
					}
				}]
			});
		}

		function main(){
			// Check support for HTML5 Local Storage
			if(typeof(Storage) == "undefined") {
				bootstrapDialog({
					type: BootstrapDialog.TYPE_DANGER,
					closable: false,
					title: 'Unsupported Browser',
					message: 'Please use:\n Chrome > 4.0\n IE > 8.0\n FireFox > 3.5\n Safari > 4.0\n Opera > 11.5',
				});
				return;
			}
			
			
			if(localStorage.getItem("ticket") != null) {
				$('#login').text("Logout");
				$("#login").attr("href", logoutURL);
				$("#login").on
			}
			
			var uri = new URI(window.location.href);
			if(uri.hasQuery("ticket")){
				console.log(uri);
				var query = URI.parseQuery(URI.parse(window.location.href).query);
				uri.removeSearch("ticket");
				location.replace(uri);
				console.log(query.ticket);
				
				// Store the ticket
				localStorage.setItem("ticket", query.ticket);
			}
			//console.log("Ticket:", localStorage.getItem("ticket"));
			
			var attrs = [];
			$.each(dataAttributes, function(key, value){
				attrs.push(key);					
			});
			$("#sampleAttributes").append("Comma separated list. Choices are: " + attrs.join(','));
			

			getRegistryPage([], 1);
		} // end main
		

		function getRegistryPage(registry, page){
			$(".spinner-h1").removeClass('hidden');
			var per_page = 100;
			$.ajax({
				type: "GET",
				headers: {'X-Auth-Token': localStorage.getItem("ticket")},
				url: hdsURL + "/registry?per_page=" + per_page + "&page=" + page,
				dataType:"json",
				success: function(res) {
					//console.log(res);

					if(res.total == 0){
						bootstrapDialog({
							type: BootstrapDialog.TYPE_INFO,
							closable: true,
							title: 'Empty registry',
							message: 'The registry contains no data sources.',
							buttons: [{
								label: 'Close',
								action: function(dialog){
									dialog.close();
								}
							}]
						});
						$(".spinner-h1").addClass('hidden');
						return;
					}

					$.merge(registry, res.entries);
					//console.log(registry);

					if(res.total>per_page*page){
						getRegistryPage(registry, page+1);
					} else {
						fillTable(registry);
					}
				},
				error: function(e) {
					var err = jQuery.parseJSON(e.responseText);
					if (e.status == 401){
						error_401();
					} else if (e.responseText != "") {
						var err = jQuery.parseJSON(e.responseText);
						bootstrapDialog({
							type: BootstrapDialog.TYPE_WARNING,
							closable: true,
							title: 'Error ' + e.status + ': ' + e.statusText,
							message: err.message,
							buttons: [{
								label: 'Close',
								action: function(dialog){
									dialog.close();
								}
							}]
						});
					} else {
						bootstrapDialog({
							type: BootstrapDialog.TYPE_DANGER,
							closable: true,
							title: 'Error ' + e.status + ': ' + e.statusText,
							message: 'Request could not be initialized.',
							buttons: [{
								label: 'Close',
								action: function(dialog){
									dialog.close();
								}
							}]
						});
					}	
					$(".spinner-h1").addClass('hidden');
				}
			}); 
		}

		function fillTable(entries){	

			// Set header
			$.each(entries[0], function(key, value){
				if($.inArray(key, omitAttrs) == -1){
					//console.log(key + ':' + value, $.type(value));

					switch($.type(value)) {
						case "array":
						console.error("json array is currently not supported.");
						break;
						case "object":
					    	// Nested object
					    	entry = ""
					    	$.each(value, function(nKey, nValue){
					    		entry += "<th class='table-meta'>" + nKey + "</th>";
					    	});
					    	break;
					    	default:
					    	entry = "<th>" + key + "</th>";
					    } 
					    $("#entries thead tr").append(entry);	
					}
				});

			// Fill data
			entries.forEach(function(entry) {
				tr = "<tr>";
				$.each(entry, function(key, value){
					if($.inArray(key, omitAttrs) == -1){

						switch($.type(value)) {
							case "array":
							console.error("json array is currently not supported.");
							break;
							case "object":
						    	// Nested object
						    	$.each(value, function(nKey, nValue){
						    		tr += "<td>" + nValue + "</td>";
						    	});
						    	break;
						    	default:
						    	tr += "<td>" + value + "</td>";
						    }
						}
					});
				tr += "</tr>";
				$("#entries tbody").append(tr);	
			});
			



			// Configure table
			var filtersConfig = {
				base_path: 'lib/tablefilter/',
				alternate_rows: true,
				rows_counter: true,
				btn_reset: true,
				loader: true,
				mark_active_columns: true,
				highlight_keywords: true,
				extensions: [{
					name: 'sort',
					images_path: 'https://koalyptus.github.io/TableFilter/tablefilter/style/themes/'
				},
				{
					name: 'colsVisibility',
					at_start: [],
					text: 'Hide Columns: ',
					enable_tick_all: false
				}
				]
			};
			entriesTable = new TableFilter('entries', filtersConfig);
			entriesTable.init();
			$(".spinner-h1").addClass('hidden');
		}

		function getTotalFiltered(){
			$(".modalStat").text("(" + entriesTable.getFilteredDataCol(0).length + " rows)");
		}

		function exportData(){
			$(".spinner-button").removeClass('hidden');
			var valid = true;
			attributes = $('#attributes').val();
			attributes = attributes.replace(/ /g,'').split(','); // remove whitespaces and split
			senmlKeys = [];
			attributes.forEach(function(attr) {
				if(!dataAttributes.hasOwnProperty(attr)){
					bootstrapDialog({
						type: BootstrapDialog.TYPE_DANGER,
						closable: true,
						title: 'Invalid Attribute',
						message: attr + ' is not a valid attribute.',
						buttons: [{
							label: 'Close',
							action: function(dialog){
								dialog.close();
							}
						}]
					});
					valid = false;
					return;
				}
				senmlKeys.push(dataAttributes[attr]);
			});
			if(!valid){
				$(".spinner-button").addClass('hidden');
				return; 
			}

			var IDs = entriesTable.getFilteredDataCol(0);
			console.log(IDs);
			var start = $('#datetimepickerStart input').val();
			var end = $('#datetimepickerEnd input').val();

			csvData = [];
			dfd = $.Deferred();
			processItems(IDs, start, end).then(function(){
				// all done
				console.log("all done");
				//console.log(csvData);
				saveCSV(csvData);
			}, function(){ // rejected
				console.log("rejected");
				$(".spinner-button").addClass('hidden');
			});

		}

		// Recursively query data for all IDs
		function processItems(IDs, start, end) {
			//console.log('called processItem');

			if(IDs.length == 0){
				// Done with all items
				dfd.resolve();
				console.log("finishing up");
				return;
			}
			id = IDs.shift(); // pop front

			var pageData = [];
			// Recursively query all pages
			function getDataPage(page){
				var per_page = 100;
				console.log("/data/" + id + "?start=" + start + "Z&end=" + end + "Z&per_page=" + per_page + "&page=" + page);

				$.ajax({
					type: "GET",
					headers: {'X-Auth-Token': localStorage.getItem("ticket")},
					url: hdsURL + "/data/" + id + "?start=" + start + "Z&end=" + end + "Z&per_page=" + per_page + "&page=" + page,
					dataType:"json",
					success: function(res) {
						//console.log(res);

						if(res.total != 0){
							for (var i = 0; i < res.data.e.length; i++) {
								var csvRow = new Array(attributes.length);
								$.each(res.data.e[i], function(key, value){
									csvRow[$.inArray(key, senmlKeys)] = value;
								});
								pageData.push(csvRow);
							}		
							//console.log(pageData);
						}

						if(res.total>per_page*page){
							// Process next page
							getDataPage(page+1);
						} else {
							var obj = {};
							obj[id] = pageData;
							csvData.push(obj);
							// Process next item
							processItems(IDs, start, end);
						}
					},
					error: function(e) {
						if (e.status == 401){
							error_401();
						} else if (e.responseText != "") {
							var err = jQuery.parseJSON(e.responseText);
							bootstrapDialog({
								type: BootstrapDialog.TYPE_WARNING,
								closable: true,
								title: 'Error ' + e.status + ': ' + e.statusText,
								message: err.message,
								buttons: [{
									label: 'Close',
									action: function(dialog){
										dialog.close();
									}
								}]
							});
						} else {
							bootstrapDialog({
								type: BootstrapDialog.TYPE_DANGER,
								closable: true,
								title: 'Error ' + e.status + ': ' + e.statusText,
								message: 'Request could not be initialized.',
								buttons: [{
									label: 'Close',
									action: function(dialog){
										dialog.close();
									}
								}]
							});
						}	
						dfd.reject();							
					}
				}); 
			}
			// Start with first page and call recursively till reaching last
			getDataPage(1); 
			return dfd.promise();
		}

		
		function saveCSV(data){

			var mode = $('#exportType').text();
			var fs;
			if (mode == "All sources in a single file") {

				var csvContent = "";
				for (var i = 0; i < data.length; i++) {

					$.each(data[i], function(key, value){
						value.forEach(function(infoArray, index){
							var dataString = infoArray.join(",");
							csvContent += index < value.length ? dataString+ "\n" : dataString;
						}); 
					});
				}
				var content = new Blob([csvContent], {type: "text/csv;charset=utf-8"});
				fs = saveAs(content, "export.csv");

			} else {

				var zip = new JSZip();
				for (var i = 0; i < data.length; i++) {

					$.each(data[i], function(key, value){
						var csvContentSingle= "";
						//if(value.length != 0){ // Store empty CSV?
							value.forEach(function(infoArray, index){
								var dataString = infoArray.join(",");
								csvContentSingle += index < value.length ? dataString+ "\n" : dataString;
							}); 
							zip.file(key+".csv", csvContentSingle);
						//}
					});
				}
				var content = zip.generate({type:"blob"});
				fs = saveAs(content, "export.zip");
			}

			// FileSaver callback
			fs.onwriteend = function() {
				$(".spinner-button").addClass('hidden');
			};
		}

		// Prevents multipe error popups
		function bootstrapDialog(dialog){
			if($.isEmptyObject(BootstrapDialog.dialogs)) {
				BootstrapDialog.show(dialog);
			}
		}
	</script>
</body>
</html>
